<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QWE Predictor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: auto;
        }
        #accuracy {
            font-size: 24px;
            margin-bottom: 20px;
        }
        #instructions {
            margin-bottom: 10px;
            color: #555;
        }
        #nextPrediction {
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .buttons {
            display: none;
            gap: 10px;
            margin-bottom: 20px;
        }
        .button {
            flex: 1;
            font-size: 24px;
            padding: 20px;
            text-align: center;
            background-color: #ddd;
            border: 1px solid #aaa;
            border-radius: 10px;
            cursor: pointer;
            user-select: none;
        }
        .button:active {
            background-color: #bbb;
        }
        #copyButton, #loadButton {
            margin: 10px 5px;
            padding: 10px;
            cursor: pointer;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #aaa;
            padding: 6px;
            text-align: center;
            word-wrap: break-word;
        }
        .correct {
            background-color: #fdd;
        }
    </style>
</head>
<body>
    <div id="accuracy">Prediction Accuracy: 0%</div>
    <div id="instructions">
        Press Q, W, or E on your keyboard and I will try to guess what you clicked. 
        Based on the <a href="https://people.ischool.berkeley.edu/~nick/aaronson-oracle/" target="_blank">aaronson-oracle</a>.
    </div>
    <div id="nextPrediction">Next Prediction: N/A</div>

    <button id="copyButton">Copy Save File</button>
    <button id="loadButton">Load N-Grams</button>

    <textarea id="ngramInput" placeholder="Paste your n-gram JSON here..."></textarea>

    <div class="buttons horizontal" id="buttonContainer">
        <div class="button" onclick="simulateKeyPress('q')">Q</div>
        <div class="button" onclick="simulateKeyPress('w')">W</div>
        <div class="button" onclick="simulateKeyPress('e')">E</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Round</th>
                <th>Your Choice</th>
                <th>My Prediction</th>
                <th>Edit</th>
            </tr>
        </thead>
        <tbody id="tally">
            <!-- Rows will be added here -->
        </tbody>
    </table>

    <script>
        const N = 5;
        const keys = ['q', 'w', 'e'];
        let history = [];  // Store each press and prediction as objects { choice, prediction }
        let ngramCounts = {};
        let round = 1;

        const accuracyDiv = document.getElementById('accuracy');
        const nextPredictionDiv = document.getElementById('nextPrediction');
        const tallyBody = document.getElementById('tally');
        const copyButton = document.getElementById('copyButton');
        const loadButton = document.getElementById('loadButton');
        const ngramInput = document.getElementById('ngramInput');
        const buttonContainer = document.getElementById('buttonContainer');

        function updateAccuracy() {
            const correctCount = history.filter(entry => entry.choice === entry.prediction).length;
            const totalRows = history.length;
            const accuracy = totalRows === 0 ? 0 : ((correctCount / totalRows) * 100).toFixed(2);
            accuracyDiv.textContent = `Prediction Accuracy: ${accuracy}%`;
        }

        function predictNext() {
            for (let n = N; n > 0; n--) {
                if (history.length >= n) {
                    const gram = history.slice(-n).map(entry => entry.choice).join('');
                    if (ngramCounts[gram]) {
                        const counts = ngramCounts[gram];
                        let max = -1;
                        let prediction = keys[Math.floor(Math.random() * keys.length)];
                        for (const key of keys) {
                            if (counts[key] > max) {
                                max = counts[key];
                                prediction = key;
                            }
                        }
                        return prediction;
                    }
                }
            }
            return keys[Math.floor(Math.random() * keys.length)];
        }

        let nextPrediction = predictNext();
        nextPredictionDiv.textContent = `Next Prediction: ${nextPrediction.toUpperCase()}`;

        function handleKeyPress(e) {
            const key = e.key.toLowerCase();
            if (!keys.includes(key)) return;
            processInput(key);
        }

        function simulateKeyPress(key) {
            processInput(key);
        }

        function processInput(key) {
            const prediction = nextPrediction;
            history.push({ choice: key, prediction });

            updateNGramCounts(key);
            addRow(key, prediction);
            updateAccuracy();

            nextPrediction = predictNext();
            nextPredictionDiv.textContent = `Next Prediction: ${nextPrediction.toUpperCase()}`;
        }

        function updateNGramCounts(key) {
            const gram = history.slice(-N).map(entry => entry.choice).join('');
            if (!ngramCounts[gram]) ngramCounts[gram] = { 'q': 0, 'w': 0, 'e': 0 };
            ngramCounts[gram][key]++;
        }

        function addRow(choice, prediction) {
            const row = document.createElement('tr');
            const roundCell = document.createElement('td');
            roundCell.textContent = round++;

            const choiceCell = document.createElement('td');
            choiceCell.textContent = choice;

            const predictionCell = document.createElement('td');
            predictionCell.textContent = prediction;

            const editCell = document.createElement('td');
            const editButton = document.createElement('button');
            editButton.textContent = 'Edit';
            editButton.onclick = () => editRow(row, choiceCell, predictionCell);
            editCell.appendChild(editButton);

            updateRowHighlighting(choiceCell, predictionCell, choice, prediction);

            row.appendChild(roundCell);
            row.appendChild(choiceCell);
            row.appendChild(predictionCell);
            row.appendChild(editCell);

            tallyBody.insertBefore(row, tallyBody.firstChild);
        }

        function updateRowHighlighting(choiceCell, predictionCell, choice, prediction) {
            if (choice === prediction) {
                choiceCell.classList.add('correct');
                predictionCell.classList.add('correct');
            } else {
                choiceCell.classList.remove('correct');
                predictionCell.classList.remove('correct');
            }
        }

        function editRow(row, choiceCell, predictionCell) {
            const newChoice = prompt('Enter new choice (q, w, or e):', choiceCell.textContent);
            if (newChoice && keys.includes(newChoice)) {
                const roundIndex = parseInt(row.cells[0].textContent) - 1;
                history[roundIndex].choice = newChoice;

                choiceCell.textContent = newChoice;
                updateRowHighlighting(choiceCell, predictionCell, newChoice, predictionCell.textContent);
                updateAccuracy();
            }
        }

        copyButton.addEventListener('click', () => {
            const saveFile = JSON.stringify(ngramCounts, null, 2);
            navigator.clipboard.writeText(saveFile).then(() => {
                alert('Save file copied to clipboard!');
            }).catch(err => console.error('Failed to copy:', err));
        });

        loadButton.addEventListener('click', () => {
            try {
                const loadedData = JSON.parse(ngramInput.value);
                ngramCounts = loadedData;
                alert('N-Grams loaded successfully!');
            } catch (error) {   
                alert('Invalid JSON format. Please check your input.');
            }
        });

        window.addEventListener('resize', adjustButtonLayout);
        document.addEventListener('keydown', handleKeyPress);

        function adjustButtonLayout() {
            const isVertical = window.innerWidth < 400;
            buttonContainer.className = isVertical ? 'buttons vertical' : 'buttons horizontal';
        }

        adjustButtonLayout();
    </script>
</body>
</html>
